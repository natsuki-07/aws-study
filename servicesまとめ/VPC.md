# VPC  
IPアドレスは重複が許されない一意の32ビットデータ。
グローバルIPアドレスは世界で重複がなく、ICANNが管理  
プライベートIPアドレスは利用範囲は限定的なエリアだけでグローバルでは重複可能  


## プライベートネットワークをどのように作るのか？  
ネットワークの範囲を定義することが必要  
例:10.0.1.0/16  
IPアドレス(10.0.1.0) + サブネットマスク(/16)がIPの範囲を決める  

CIDRを利用して、サブネットマスクの値を設定し、同じネットワークとして扱うIPアドレスの個数を調整できるIPアドレスの設定方法  
/16の場合は左から16個が固定されていて残りが自由に使える。  

10.0.0.255/8の場合は左から8桁つまり10(00001010)をロックし変更不可とする  
10.0.0.255/16の場合は左から16桁つまり10.0まで  
10.0.0.255/24の場合は左から24桁つまり10.0.0まで  

10.0.0.0/16は10.0.0.0 ~~ 10.0.255.255まで利用可能。左から10.0の部分をネットワーク部、右から0.0をホスト部と呼ぶ  
サブネットを大きくすると利用できる範囲が小さくなる。  


## VPCとは何か  
Vertual Private Cloud の略称で利用者ごとにAWSクラウドのネットワークからユーザー専用の領域を切り出してくれる仮想ネットワークのサービス  
インターネットゲートウェイと呼ばれるインターネット側の出口を付けることで直接インターネットに出ていくことが可能  
またオンプレミスの各拠点をつなげるために仮想プライベートゲートウェイを出口として専用線のサービスであるDirect ConnectやVPN経由で直接的にインターネットに出ることなく各拠点と接続することも可能。  

インターネットゲートウェイへのルーティングの有無でサブネットのタイプが分かれる。  
VPCから外部にあるリソースに接続するにはパブリックアドレスかエンドポイントを使う。  

設計時は将来の拡張も見据える必要がある。またモニタリングをできるようにする必要がある。  


### ルートテーブル  
ルーティング要素にはルートテーブルと各種ゲートウェイがある。１つのルートテーブルを複数のサブネットで共有することはできるが、１つのサブネットに複数のルートテーブルを適用することはできない  
VPCにはメインルートテーブルがあり、サブネット作成時に指定しない場合のデフォルトのルートテーブルになる。
  
  
### セキュリティグループとネットワークACL  
セキュリティグループはEC2, ELB, RDSなどインスタンス単位の通信制御に利用する。インスタンスには少なくとも１つのセキュリティグループをアタッチする必要があり、インバウンド(内向き、外部からVPCへ)とアウトバウンド(外向き、内部から外部へ)の両方の制御が可能。  
制御項目としてはプロトコル(TCPやUDPなど)とポート範囲、送受信先のCIDRかセキュリティグループを指定する。セキュリティグループはデフォルトではアクセスをすべて拒否する。  
     


ネットワークACLはサブネットごとの通信制御に利用する。制御できる項目はセキュリティグループと同様。セキュリティグループと違って送受信先にはセキュリティグループでの指定はできない。デフォルトではすべてを許可する。  
  

### ゲートウェイ  
ゲートウェイはVPCの内部と外部との通信をやり取りする出入口。  
- インターネットゲートウェイはVPCとインターネットとを接続するためのゲートウェイ。ルートテーブルでインターネットゲートウェイをターゲットに指定すると、その宛先にアドレスと通信はインターネットゲートウェイを通してインターネットに向けられる。  

- NATゲートウェイはネットワークアドレス変換機能を有し、プライベートIPをNATゲートウェイが持つグローバルIPに変換し外部と通信する。AZに依存するのでAZごとに作成し、冗長性を高める必要がある。  

- 仮想プライベートゲートウェイ(VGW)はVPCがVPNやDirect Connectと接続するためのゲートウェイ。VPCに一つだけアタッチすることができるが、複数のVPNやDirect Connectと接続することが可能。
  

### VPCエンドポイント  
VPCないからインターネット上のAWSに接続するほかの方法としてVPCエンドポイントと呼ばれる特殊なゲートウェイを利用する方法がある。  
S3やDynamoDBと接続する際に利用するゲートウェイエンドポイントとそれ以外の大多数のサービスで利用するインターフェイスエンドポイント(AWS PrivateLink)がある。  
ゲートウェイポイントはルーティングを利用したサービスで、エンドポイントを作成しサブネットと関連付けると、そのサブネットからS3、DynamoDBへの通信はインターネットゲートウェイではなくエンドポイントを通じて行われる。  
セキュリティの観点でインターネットを経由したくないときには重要な要素となる。  
  
エンドポイントには2種類ある  
- VPCエンドポイント(ゲートウェイ型)・・・ルートテーブルの指定されたターゲットとなるゲートウェイ。サポートされるAWSのサービスをあて先とするトラフィックをVPC内外で接続する際に使用する  
  
- VPCエンドポイント(プライベートリンク型)・・・対象サービスをあて先とするトラフィックのエントリポイントとなるプライベートIPアドレスを持つElastic Network Interface  
  

### ピアリング接続  
VPCピアリングは2つのVPC間でプライベートな接続をするための機能で、同一AWSアカウントのVPC間のみならず、AWSアカウントを跨っての接続も可能。通信相手はEC2インスタンスなどであり、IGWやVGWなどにトランジットすることはできない。  


### VPCフローログ  
VPC内の通信の解析にはVPCフローログを利用する。  
VPCフローログはAWSでの仮想ネットワークインターフェイスカードであるENI（Elastic Network Interface)単位で記録される。記録される内容は、送信元・先アドレスとポート、プロトコル番号、データ量と許可/拒否の区別。  


### Direct ConnectとDirect Connect Gateway  
AWSとオフィスやデータセンターなどの物理拠点とを専用線でつなげたい場合はAWS Direct Connectを利用する。  VPNと比べて遅延やパケット損失率が低下し、スループットが向上するなど安定したネットワーク品質で利用することができる。  
またアウトバウンドトラフィック料金はDirect Connectと接続したほうが安価になる。   

Direct Connect Gatewayを利用すると、1つのDirect Connect接続で拠点と複数のAWSアカウントやVPCに接続することができる。  

また複数のVPCとオンプレミスネットワークを中央ハブを介して接続するAWS Transit Gatewayというサービスもある。  
  
