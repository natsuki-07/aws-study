# Security
## ネットワークのセキュリティ
VPCではAWS上でプライベートな仮想ネットワークを定義できる。
  
- ルートテーブルとサブネットでの制御:  
インターネットゲートウェイに対するルートのあるパブリックサブネットとルートのないプライベートサブネットがある。直接アクセスしたいロードバランサーなどをパブリックサブネットに配置する。インターネットから直接アクセスしないEC2インスタンスやRDSデータベースインスタンス、ElasticCacheノードなどは、プライベートサブネットで外部の攻撃から保護する。プライベートサブネットで保護しているEC2インスタンスが、インターネット上の情報にアクセスする必要がある場合は、NATゲートウェイをパブリックサブネットに設置する。
  
- ネットワークACLとセキュリティグループでの制御:  
VPCにはセキュリティグループとネットワークACLの2つのファイアウォール機能がある。セキュリティグループはEC2インスタンスなど、VPC内のリソースにアタッチされている`Elastic Network Interface(ENI)`に設定する。インバウンドとアウトバウンドの許可ルールを設定する。ネットワークACLはサブネットを対象に設定する。インバウンドとアウトバウンドの拒否・許可ルールを設定する。ルール番号があり、番号が小さいほうが優先される。
  
- VPCエンドポイント
VPCはVGW(仮想プライベートゲートウェイ)をアタッチして、オンプレミスデータセンターなどのルーターとVPN接続することができる。VPCエンドポイントを使うことで、インターネットゲートウェイを返さずにAWSの各サービスのAPIに直接リクエストを実行できる。VPCエンドポイントには、ゲートウェイエンドポイントとインターフェースエンドポイントがある。どちらもネットワークレイヤーのセキュリティ要件を満たすのに、検討の上で選択される。  
  
ゲートウェイエンドポイントをVPCにアタッチして、サブネットに関連付けているルートテーブルでゲートウェイエンドポイントへのルートを設定する。ゲートウェイエンドポイントを使用するサービスはS3とDynamoDBの2つだけ。  
  
インターフェースエンドポイントはサービスAPIを宛先とするプライベートIPアドレスを持つENIをサブネットに作成する。様々なサービスのインターフェースエンドポイントを作成できる。  
  
## 認可と認証
プログラムを実行する場合認証と認可が必要となる。IAMユーザーが再任したりコマンドを実行したりする際の認証情報は2つある。1つはマネジメントコンソールにサインインするときに必要な12桁のアカウントID、ユーザー名、パスワード。もう一つはCLIでコマンドを実行したり、SDKでコーディングしたプログラムを実行するときに必要なアクセスキーID、シークレットアクセスキー。  
  
2つの認証情報は、IAMユーザーに対して設定することができる。オフィスや自宅などのローカルのPCから、AWSCLIによるコマンド操作やSDKを使った開発テストをする場合は`aws configure`によってアクセスキーIDとシークレットアクセスキーを設定するのが一般的。aws configureによって設定した、アクセスキーIDとシークレットアクセスキーは、ローカルのユーザーホームディレクトリに.awsという隠しディレクトリができて、そこにcredentialsという名前で保存される。  
  
本番環境と開発環境を間違えて操作してしまう可能性もあるのでｍプロファイラを使って認証を分けておくこともできる。名前付きプロファイラはAWS CLIコマンドに適用できる設定と認証のあつまり。  
  
IAMポリシーはアクセス権限を設定するドキュメントでJSONフォーマットで記述する。AWS Policy Generatorを使うことでJSONを直接書かなくてもポリシーを作成することができる。  
```
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject"
      ],
      "Resource": "arn:aws:s3::blog-image/*"
    }
  ]
}
```
- Statement: 許可(拒否)を複数設定する
- Effect: 許可化拒否を設定する
- Action: 許可するアクションのAPIを設定する
- Resource: アクションの対象リソースを指定する
  
ARNは(Amazon Resource Name)で、書式は`arn:aws:service:region:account:resource-id`のようになる  
- arn:awsは先頭に必要
- service: s3などのサービス名を指定
- region: us-east-1などリージョンコードを指定する
- account: 12桁数値のアカウントIDを指定する
- resource-id: リソースを識別する名前やIDを指定する。
  
`Condition`で追加の条件を指定することができる。次の例の場合、特定のIPアドレスからリクエストを実行したときだけ許可したいということができる  
```
"Condition": {
  "IpAddress": {
    "aws:SourceIP": "11.22.33.44/32"
  }
}
```
特定のIPアドレス以外で制限する場合は、`NotIpAddress`を使用する。他の演算子には以下のようなものがある  
  
- StringEquals・・・文字列完全一致。タグを条件に含める場合などに使用する。他にStringNotEqualsなど一致しないケースやStringLikeなど部分一致の演算子もある  
  
- NumericEquals・・・数値一致。リクエストに含まれるリストの最大数で制限する場合などに使用する。他にNumericNotEqualsなど一致しないケースの演算子や、NumericLessThanなどの比較演算子もある
  
- DateEquals・・・日付一致。特定の日だけ許可したいケースなどで使用する。他にDateNotEqualsなど一致しないケースの演算子やDateLessThan(より前の日)のような演算子などもある。  
  
- Bool・・・true, falseで指定したい場合に使用  
  
- ArnEquals・・・Arnの送信一致。送信元リソースのARNを指定するケースなどで使用する。ArnLikeで部分一致を判定したり、ArnNotEqualsで除外するケースの演算子もある。
```
"Condition": {"NumericLessThanEquals": {"s3:max-keys": "20"}}
```
  
ポリシー変数を使用すると効率よくポリシーを作成、管理することができる。
```
"Condition": {"StringLike": {"s3:prefix": ["${aws:username}/*"]}}
```
  
### フェデレーション
IAMロールを使用することで、外部認証されたユーザーをAWSで認証することもでき、これをフェデレーションという。  
  
すでにSAML2.0をサポートしているidP(IDプロバイダー)を使っている場合は、IAMユーザーを作成しなくても既存のidPで認証したユーザーにシングルサインオン(SSO)を提供できる。  
Active Directoryとの統合や、IDaaS(OneLogin, Oktaなど)との統合が簡単に行える。SSOについてはSAML2.0をサポートしているidPであれば、コーディングなしで実現できる。
  
## Amazon Cognito
Webアプリケーションやモバイルアプリケーションに安全に認証を提供するサービス。Cognitoのサービスリソースは大きく分けると2つあり、ユーザープールとIDプールという  
  
### ユーザープール  
ユーザープールでは以下のことができる
- サインアップ・サインインを簡単にアプリケーションに実装・・・ユーザー基盤をオリジナルで開発しなくても、モバイルアプリケーションやWebアプリケーションからのサインアップ、サインイン機能を簡単に実装できる  
  
- カスタム可能な組み込みサインインUI・・・オリジナルのユーザーインターフェースを開発して、Cognitoユーザープールを使うことも可能だが、Cognitoユーザープールにはカスタマイズ可能な組み込みWebUIがあり、すぐに使い始めることもできる。  
  
- ユーザープロファイルの管理・・・ユーザープールにはユーザーディレクトリとしても機能する。ユーザーがログインするために必要な情報、ステータス管理、パスワードのリセットなどのようにアプリケーションのユーザーディレクトリに必要な機能がある
  
- MFA、本人確認などユーザー認証の一般的な機能・・・パスワードポリシー、ユーザーサインアップの許可、メールアドレス、電話番号の検証、MFA、アドバンスセキュリティ(これを有効にするとユーザープールに記録されたIDとパスワードが、他のウェブサイトで漏洩情報として公開されたときにユーザーをブロックするなどの自動対応ができる)  
   
- Lambdaトリガー・・・サインアップ・サインインイベントをトリガーにしてAWS Lambda関数を実行できる。  
  
- Web IDフェデレーション・・・Congitoでは外部のID認証を使うことも可能。
  
### IDプール
Cognito IDプールにはIAMロールと認証プロバイダーを設定できる。認証プロバイダーには直接Web IDフェデレーションを設定できるが、Cognitoユーザープールも設定できるので、外部IDフェデレーションを使う場合もユーザープールを使用できる。   
  
GetIdリクエストによってCognito IDを取得する。GetCredentials Forldentityリクエストによって最終的にIAMロールに対してAssumeRoleがリクエストされて、一時的なアクセスキーID、シークレットアクセスキー、トークンがアプリケーションに渡される。これによってアプリケーションはIAMロールにアタッチされた権限に基づいて、AWSサービスへのリクエストを実行できる。　
  

## シークレット情報の管理 
### AWS Systems Manager パラメータストア
パラメータストアに書き込んだパラメータをEC2インスタンスからGetParameterで取得して使用する。こうすることでEC2インスタンスがオーとスケーリングによって追加されたときも接続情報をEC2インスタンスのOSローカル上に保存する必要はない。パラメータストアでは、一般的に文字列を扱う。パスワードなどのシークレット情報はKMSと連携してセキュアな暗号化保存ができる。暗号化のタイプはSecureString。  
  
### AWS Secrets Manager
Secrets Managerは設定された周期でLambda関数を自動実行し、データベースのパスワードを変更してSecrets Managerのシークレット情報を更新する。ランダムなパスワードを設定し、ユーザーが知ることなくSecrets Managerに保存される。  
  
  

## 暗号化
### AWS Certificate Manager
AWS Certificate ManagerはCloudFront、Elastic Load Balancing、API Gatewayと連携して、ユーザー所有ドメインの証明書を設定することができる。所有者の確認はメール認証かCNAME認証で行われる。
  
### AWS Key Management Service(KMS)
暗号化するためのキーを作成・管理できる。データキーを生成してオブジェクトやインスタンスの暗号化を行う。暗号化に使用したデータキーはCMK(Customer Master Key)によって暗号化される。この方法をエンベローブ暗号化という。暗号化に使用するキーの管理に専用のハードウェアが必要となるような厳しい要件にはAWS CloudHSMを検討する
  
### S3オブジェクトの暗号化
S3オブジェクトの代表的な暗号化方法は、クライアントサイド暗号化(2種類)とサーバーサイド暗号化(3種類)ある。  
クライアントサイド暗号化(CSE-KMS、CSE-C)は、暗号化してからアップロードする方法で、暗号化する際に使用するキーとしてKMSを使用する方法と独自のキーを使用する方法が考えられる。クライアントサイドの暗号化は、アップロードする前に暗号化しなければならないよう県に対応できる。CSE-Cはオンプレミスキーサーバーなどで作成荒れ田キーを使用して暗号化する方法で、CSE-KMSはKMSで管理しているCMKを使用して暗号化してからアップロードする方法。  
  
サーバサイド暗号化(Server Side Encryption: SSE)はS3に保管されるデータの暗号化。AWSデータセンターのディスクに書き込まれるときに暗号化され、オブジェクトデータにアクセスするときに復号化される。
- SSE-S3・・・S3が管理するキーによるサーバー側暗号化を行う。ユーザーがキーを管理しなくてもいい方法  
  
- SSE-KMS・・・KMSで管理しているキーを使ったサーバー側暗号化。ユーザーが管理するCMKで制御できる。個別管理要件がある場合にも選択できる。キーポリシーでCMKへのアクセス制御できる。またCloudTrailによる追跡監査が可能で、1年ごとの自動キーローテーションもできる。  
  
- SSE-C・・・ユーザー指定キーによるサーバー側暗号化。オンプレミスキーサーバーなどで作成されたキーを使用することもできる。