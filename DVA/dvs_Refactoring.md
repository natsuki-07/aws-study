# リファクタリング
## スケーラビリティを確保する
- EC2:  
EC2 Auto Scalingで実現する。CloudWatchアラーム・時間・予測型を使用して、リクエストの状態に応じてEC2インスタンスを増やしたり、減らしたりする。Webアプリケーションだけではなく、SQSと組み合わせたワーカーアプリケーションでも、メッセージ数によりCloudWatchアラームをトリガーとしてオートスケールを設定できる
  
- Lambda:  
Lambda関数はリクエストやイベントの発生数だけコードが実行される。もともとスケーラビリティが備わったサービス
  
- RDS:
RDSのスケーラビリティは基本的に垂直スケーリングだが、リードレプリカを使用することにより、読み込み専用で数も5インスタンスまで水平スケーリングができる  
  
- Aurora:  
RDSと同様だが、リードレプリカは15インスタンスまで作成できる。またストレージ容量も自動的に増加する。またAurora Serverlessを使用すると、ACUの最小数と最大数を決めることができ、リクエストの状況に応じて自動で増減する  
  
- DynamoDB:  
WCU(1KBの項目を1秒に1回書き込み)、RCU(4KBの項目を1秒に2回結果整合性で読み込み、または1回強い整合性で読み込み)を設定するプロビジョンドキャパシティモードと、発生したリクエストをすべて処理するオンデマンドモードがある。オンデマンドモードではリクエストはすべて処理するため、リクエスト量に変動があっても問題ない。プロビジョンドキャパシティモードではWCU, RCUを最小値と最大値の範囲内で、CloudWatchアラームによってオーとスケーリングすることができる。ストレージは無制限  
  
- S3:  
ストレージは無制限。パフォーマンス面では、プレフィックスごとに1秒当たり3500回以上のPUT, COPY, POST, DELETEリクエストか、5500回以上のGET, HEADリクエストに対応できる。それ以上のリクエストが発生しうるシステムでは、プレフィックスを分けてスケーラビリティを確保する。

## 環境の自動化
人の手を介さないことによってより早く、より正確に必要なリソースを用意することができる。AWSではすべてのサービスがAPIによって操作できるので、自動化の対象となる。

## 使い捨て可能にする
オーとスケーリングによってスケールアウトやスケールインをするインスタンスが、情報や状態を持ち続けていると簡単に追加・削除ができなくなる。ALBを使って複数のEC2インスタンスにリクエスト情報を分散している構成でEC2インスタンスのローカルにセッション情報を持っている場合は、ステッキーセッションを使用して同じインスタンスにリクエストを送信し続けるようにする。  
  
ステッキーセッションのデメリットは、リクエストが偏る可能性があることと、そのEC2インスタンスに障害が発生すると、セッション情報が失われてしまう点にある。この問題を解決するデザインパターンとしてセッションステートレスがある。

## 疎結合にする
マイクロサービスやサーバレスアーキテクチャのアプローチで開発した各サービス間の通信を直接行っていると、ちょっとした障害がシステム全体に影響してしまうこともある。それぞれのサービスの処理を非同期化することで、この問題を解決できる可能性がある。サービス間の依存性を減らして、お互いの障害や変更の影響を減らす設計が疎結合か

## サーバーではなくサービスを設計
EC2を前提に設計しなければ、様々な機能ニーズを、サーバーを管理することなく柔軟に満たすことがやりやすくなる。

## 適切なデータベースを選択
データベースはそれぞれの目的のために作られる。最適な設計にするためには、最適なデータベースを選択する必要がある。
  
- RDS  
Oracle, Microsoft SQL Server, MySQL, PostgreSQL, MariaDBが必要なときに選択。オンプレミスでこれらのデータベースを使用していて、アプリケーションの設計変更をしない場合など。
  
- Aurora  
MySQL, PostgreSQLが必要な時。Aurora Serverlessを使用すれば、状況に応じてリソースが変化し、必要な分に対してだけ課金される。
  
- DynamoDB  
非リレーショナルデータベース。NoSQLとも呼ばれる。水平的にスケーリングし、ユーザーやリクエスト量が変動するアプリケーションでも対応
  
- Redshift  
DWHサービス。BIツールなどのデータソースとして指定して、分析や集計で利用する。非常に高速なクエリを実行できる。またRedshift Spectrumというサービスを使用すると、S3バケットに保存されたCSVやJSON、Parquetなどの大量なデータの高速分析も行える。  
  
- ElasticCache  
Memcached, Redisが用意されている。両方とも主にデータベースやリクエストに対してのキャッシュを持ちアプリケーションのデータ取得をより高速にし、様々なユースケースで利用される。Redisはより高機能で、Pub/Subをサポートしたメッセージブローカーとして使用されたり、データベースそのものとして使用されるケースもあります。
  
- Neptune  
グラフデータベース。SNSやアドテックなどのユースケースで使用される。このようあユースケースにある、複雑な関連性を借りするのに最も適した機能を備えているから。

## 単一障害をなくす
AWSでは大量のリソース、データセンターが用意されている。データセンターのグループ、AZも各リージョンに必ず2つ以上存在する。２つ以上のAZを使用して設計するのが高可用性のシステムを開発するうえでは必要。

## コストを最適化する
AWSの各サービスは従量課金。従量課金の要素は各サービスによってさまざまだが、主に容量とリクエストに対しての課金。容量とは、保存容量、転送容量、使用しているコンピューティング容量と利用時間など。リクエストはその回数など。
  
- APIの開発  
EC2で構築したAPIを運用して、リクエストがないときに待ち受けている時間にコストを発生させるよりもAPI GatewayとLambdaを使って開発することで、リクエストが発生したときだけの効率的なコスト利用ができる
  
- CI/CD環境の構築  
ソースバージョン管理、ビルド環境、デプロイ自動化を自前サーバーで構築するよりもCodeStarを使った方が数クリックでCI/CD環境を構築できて、開発コストを下げることができる。  
  
- DynamoDBの開発  
項目を取得する際に、強い整合性を選ぶことはできるが、コストは結果整合性の2倍になる。結果整合性で構わないところは結果整合性で項目を取得する。

## キャッシュを使用する
キャッシュを使うことで同じ結果を求めるリクエストを何度も実行する必要がなくなるため、負荷が減り、パフォーマンスとコストの最適化につながる。
  
ElasticCacheの2つの戦略  
  
- 遅延キャッシュ  
まずキャッシュをゲットしてみて、あれば使用する。なければデータベースにクエリを実行してキャッシュをセットする  
  
- 書き込みスルー(ライトスルー)  
データベースを更新するときは、ElasticCacheにも書き込んでおく。読み込みは必ずElasticCacheから行う

## すべてのレイヤーでセキュリティを実装
ネットワークレイヤーでもアプリケーションレイヤーでもセキュリティを設定する。

## 増え続けるデータを処理する
S3やDynamoDBなどのストレージ無制限のサービスを利用して、増え続けるデータを管理する。S3はデータレイクとしてよく利用される。

# 移行
6つのR  
1. リホスト・・・そのままの構成でAWSへもっていく
  
2. リプラットフォーム・・・プログラムコードは変更せず、最適化を検討する  
  
3. 再購入・・・製品やサービスの再検討をする  
  
4. リファクタリング/再設計・・・replatformやrepurchaseプログラムのカスタマイズ、または作り直しをする
  
5. リタイア・・・廃止  
  
6. retain・・・保持。何も買えない