# モニタリング
## CloudWatch
### メトリクス
AWSの各サービスの数値情報をモニタリングできる。標準メトリクスとして、各サービスを使っていれば自動で取得されているものに加え、カスタムメトリクスとして独自の数値情報を送信することも可能。カスタムメトリクスの送信にはPutMetricData APIアクションを実行する。  
  
EC2ではハイパーバイザーレベルで取得可能な数値情報を、標準メトリクスとして自動取得している。メモリの空き情報などOSレベル以上の情報については取得していない。必要に応じてカスタムメトリクスでの取得を検討する。  
  
- CPUUtilization・・・EC2で使用されているCPUの比率  
- NetworkIn・・・インスタンスが受診したバイト数  
- NetworkOut・・・インスタンスから送信したバイト数  
- StatusCheckFailed・・・インスタンスのステータスチェックとシステムステータスチェックのいずれかに失敗した場合は1, それ以外は0  
  
  
EBS  
- VolumeReadOps・・・ディスク読み取り回数  
- VolumeWriteOps・・・ディスク書き込み回数  
  
RDS  
RDSではOSもAWSが管理しているので、メモリの空き情報なども標準メトリクスで取得されている。
- DatabaseConnections・・・データベース接続数  
- ReadIOPS・・・ディスク読み取り回数  
- WriteIOPS・・・ディスク書き込み回数  
- FreeableMemory・・使用可能なメモリ容量  
  
  
S3  
S3ではストレージメトリクスは標準メトリクスだが、リクエスト数などリクエストメトリクスはカスタムメトリクス。
- BucketSizeBytes・・・保存されているオブジェクトデータの量  
- NumberOfObjects・・・オブジェクトの合計数  

### CloudWatch Logs
CloudWatch LogsはCloudWatchエージェントをインストールしてセットアップすることが、最も素早くシンプルに始める方法。
  
セットアップの手順は
1. IAMロールの作成  
  
IAMロールはEC2用として作成し、`CloudWatchAgentAdminPolicy`と`AmazonSSMManagedInstanceCore`の2つのAWS管理ポリシーをアタッチする。セットアップが終わったら、CloudWatchAgentAdminPolicyはでタッチして、CloudWatchServerPolicyに変更する。違いは`ssm:PutParameter`アクションがあるかないか。セットアップ時に設定ファイルの内容をパラメータストアに書き込むためにssm:PutParameterアクションが必要。運用を開始すれば、`ssm:GetParameter`だけで必要な権限を満たせるのでCloudWatchAgentServicePolicyに変更する。  
  
2. Systems Managerを使用してCloudWatchエージェントをインストール  
  
Systems ManagerコンソールのディストリビューターにAmazonCloudWatchAgentがあるので選択する。『1回限りのインストール』を押下すると、Run CommandでCloudWatchエージェントをインストールするための設定が反映される。  
  
3. CloudWatchエージェント設定ファイルの作成  
  
設定ファイルの作成はターミナルからコマンドで実行する。
  
4. CloudWatchエージェントの開始  
  
CloudWatchエージェントをSystems Manager Run Commandから実行する。

## VPCフローログ
VPC内のENI(Elastic Network Interface)を通過するIPトラフィックに関する情報をキャプチャできる機能。有効にする場合は、VPC単位、サブネット単位、ENI単位で設定できる。ログの単位はENI。VPCフローログによってセキュリティグループやネットワークアクセスコントロールリストの設定が正しいかどうかテストしたり、想定した通りの通信が許可されていないときに調査を行ったりすることが可能  
  
CloudWatch Logsへの発行する場合は、IAMロールが必要。CloudWatch LogsにはENIごとにフローログが出力される。  
  
S3バケットへの発行は、バケットポリシーで許可を設定する。

## AWS CloudTrail
AWS CloudTrailは、AWSアカウント上で行われたAPIアクションのほとんどを記録する。マネジメントコンソール、CLI、SDKなどからの操作は、すべてAPIを通じてリクエストが実行されるので、これらの操作も記録される。ログはS3バケットに保存する。  
  
CloudTrailを有効にすることで、追跡可能性を有効にできる。  
- EC2インスタンスを終了したユーザーを特定する  
- 情報漏洩の原因となったセキュリティグループの変更をしたユーザーを特定する  
- 不正アクセスをしたユーザーが何を実行したかを証明する  
- ブロックしたリクエストによって攻撃が発生していることを知る  
  
記録は指定したS3バケットに保存されているが、過去90日の記録はマネジメントコンソールから検索することもできる。

## AWS X-Ray
AWS X-Rayによって、アプリケーションの潜在的なバグを特定したり、パフォーマンスのボトルネックを特定できる。モニタリングが複雑になるマイクロサービスにおいても、マップで可視化してトレース分析を可能とする。

# トラブルシューティング
## スロットリングエラー
リクエストの拒否や遅延が発生する原因にスロットリングエラーがある。これはサービスAPIの制限リクエスト回数に達したため発生する。制限リクエスト回数は、ユーザーが設定しているものや、サービスのデフォルトで決まっているもの、サービスの上限として決まっているものなどがある。ユーザーが設定しているものは、回数を増やすことで対応できる。サービスのデフォルトはクォータを引き上げる申請をすることで対応できる。
  
Lambdaの同時実行数の制限に達してさらにリクエストが発生した場合には、RateExceededエラーを受け取る。CloudWatchでは、全体、または関数ごとのThrottlesメトリクスでモニタリングできる。
  
## エクスポネンシャルバックオフ
スロットリングエラーや5xxサーバ側のエラーが発生した際には、アプリケーションからの再試行が必要。SDKを使用していると自動再試行ロジックが実装されているので、開発者が再試行ロジックを実装する必要がない。SDKでは、再試行のロジックとしてエクスポネンシャルバックオフアルゴリズムを実装している。エクスポネンシャルバックオフの目的は、無駄な再試行リクエストを減らすこと。そのため、再試行前の待機時間を徐々に長くしたりランダムな遅延時間を使用したりする。  
  
## セキュリティトラブルシューティング
AWSサービスに対してのリクエストが拒否される原因は、IAMポリシーで許可されていないか、拒否されているのいずれか。IAMポリシーは、IAMユーザーやIAMロールに設定されているもの以外に、リソースベースのポリシーもあるので、確認する対象が複数ある。